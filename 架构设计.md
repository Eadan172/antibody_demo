# 架构设计文档

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         输入层 (Input)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  JSON文件   │  │  数据库     │  │  API接口    │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │
          └────────────────┴────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据处理层 (Data Processing)                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              数据加载与清洗 (load_antibody_data)          │   │
│  │  • 字段完整性检查    • 类型安全转换    • 业务规则校验      │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              虚拟筛选引擎 (screen_antibodies)             │   │
│  │  • 硬约束过滤        • 综合评分计算    • Top-K排序        │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              报告生成器 (generate_report)                 │   │
│  │  • 控制台输出        • JSON报告生成    • 日志记录         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        输出层 (Output)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  控制台日志 │  │  JSON报告   │  │  可视化图表 │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 数据流图

```
原始数据 (1000条)
    │
    ▼
┌─────────────────┐
│   数据加载模块   │  ← 字段检查、类型转换、规则校验
└────────┬────────┘
         │
         │ 有效数据 (~950条)
         ▼
┌─────────────────┐
│   筛选引擎      │  ← 硬约束过滤
└────────┬────────┘
         │
         │ 通过数据 (~100条)
         ▼
┌─────────────────┐
│   排序模块      │  ← 综合评分、Top-K排序
└────────┬────────┘
         │
         │ Top-5结果
         ▼
┌─────────────────┐
│   报告生成      │  ← JSON输出、日志记录
└─────────────────┘
```

## 3. 模块关系图

```
                    ┌─────────────────┐
                    │   CONFIG配置    │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  load_antibody_ │ │  screen_        │ │  generate_      │
│  data           │ │  antibodies     │ │  report         │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ AntibodyCandidate│ │ 综合评分算法    │ │ JSON报告        │
│ 数据模型        │ │ 硬约束过滤      │ │ 控制台输出      │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 4. 核心数据结构

### 4.1 AntibodyCandidate 数据模型

```python
@dataclass
class AntibodyCandidate:
    id: str                      # 抗体唯一标识
    sequence: str                # 氨基酸序列
    stability_score: float       # 稳定性评分 (0-100)
    solubility_score: float      # 溶解度评分 (0-100)
    immunogenicity_score: float  # 免疫原性评分 (0-100)
    binding_affinity: float      # 结合亲和力 (KD值)
    
    @property
    def composite_score: float   # 综合评分（加权计算）
```

### 4.2 配置文件结构

```yaml
stability_threshold: 75.0       # 稳定性阈值
solubility_threshold: 60.0      # 溶解度阈值
immunogenicity_threshold: 30.0  # 免疫原性阈值
top_k: 5                        # 输出数量
batch_size: 100                 # 批处理大小
weights:                        # 评分权重
  stability: 0.30
  solubility: 0.25
  immunogenicity: 0.25
  binding_affinity: 0.20
```

### 4.3 输出报告结构

```json
{
  "timestamp": "ISO8601格式时间戳",
  "summary": {
    "total_input": "输入总数",
    "passed_count": "通过数量",
    "pass_rate": "通过率"
  },
  "top_candidates": [
    {
      "rank": "排名",
      "id": "抗体ID",
      "sequence": "序列",
      "composite_score": "综合评分"
    }
  ],
  "recommendations": ["推荐理由列表"]
}
```

## 5. 扩展架构设计

### 5.1 大数据量场景（10万+条）

```
┌─────────────────────────────────────────────────────────────┐
│                     大数据量处理架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   数据存储层        计算层              缓存层        输出层   │
│  ┌─────────┐    ┌───────────┐      ┌─────────┐   ┌────────┐ │
│  │PostgreSQL│───▶│ 批处理引擎 │─────▶│  Redis  │──▶│  Web   │ │
│  │  +索引  │    │(多进程并行)│      │ 缓存TopK│   │ 前端   │ │
│  └─────────┘    └───────────┘      └─────────┘   └────────┘ │
│                                                             │
│  优化策略：                                                  │
│  1. 数据库分页查询，避免内存溢出                              │
│  2. 多进程并行处理，充分利用多核CPU                           │
│  3. Redis缓存中间结果，加速重复查询                           │
│  4. 异步任务队列，削峰填谷                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Web服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Web服务架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   用户界面        API网关         业务层          数据层      │
│  ┌────────┐     ┌────────┐    ┌───────────┐   ┌─────────┐  │
│  │ React  │────▶│ Flask  │───▶│  筛选引擎  │──▶│  SQLite │  │
│  │   UI   │     │  API   │    │  (核心逻辑)│   │/PostgreSQL│  │
│  └────────┘     └────────┘    └───────────┘   └─────────┘  │
│                                                             │
│  功能模块：                                                  │
│  • 文件上传（Excel/CSV）                                     │
│  • 参数配置（阈值调整）                                       │
│  • 实时进度展示                                              │
│  • 结果可视化（图表）                                         │
│  • 历史记录查询                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 大模型集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                     大模型集成架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   筛选结果        LLM服务         生成内容                   │
│  ┌────────┐     ┌────────┐    ┌───────────────┐            │
│  │ Top-5  │────▶│ OpenAI │───▶│ 推荐理由生成  │            │
│  │ 抗体   │     │ /本地  │    │               │            │
│  │ 数据   │     │ 模型   │    │ • 优势分析    │            │
│  └────────┘     └────────┘    │ • 风险提示    │            │
│                               │ • 优化建议    │            │
│                               └───────────────┘            │
│                                                             │
│  Prompt设计示例：                                            │
│  "基于以下抗体理化指标，生成一段专业的推荐理由：              │
│   稳定性: {score}，溶解度: {score}，免疫原性: {score}..."    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 6. 接口文档

### 6.1 输入接口

**Endpoint**: `POST /api/screen`

**Request Body**:
```json
{
  "candidates": [
    {
      "id": "string",
      "sequence": "string",
      "stability_score": "number",
      "solubility_score": "number",
      "immunogenicity_score": "number",
      "binding_affinity": "number"
    }
  ],
  "config": {
    "stability_threshold": 75.0,
    "solubility_threshold": 60.0,
    "immunogenicity_threshold": 30.0,
    "top_k": 5
  }
}
```

**Response**:
```json
{
  "code": 200,
  "data": {
    "timestamp": "2026-02-27T10:44:31.264980",
    "summary": {...},
    "top_candidates": [...],
    "recommendations": [...]
  }
}
```

### 6.2 状态查询接口

**Endpoint**: `GET /api/status/{task_id}`

**Response**:
```json
{
  "code": 200,
  "data": {
    "task_id": "string",
    "status": "running|completed|failed",
    "progress": 85,
    "result": {...}
  }
}
```

## 7. 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      生产环境部署                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   负载均衡        应用集群         数据层         监控层      │
│  ┌────────┐    ┌──────────┐    ┌─────────┐   ┌─────────┐   │
│  │  Nginx │───▶│  Docker  │───▶│PostgreSQL│──▶│Prometheus│   │
│  │        │    │  ×3节点  │    │  主从    │   │+Grafana │   │
│  └────────┘    └──────────┘    └─────────┘   └─────────┘   │
│                                                             │
│  部署方式：                                                  │
│  • Docker Compose（开发/测试）                               │
│  • Kubernetes（生产环境）                                    │
│  • Serverless（云函数，轻量级场景）                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

**文档版本**: v1.0  
**更新日期**: 2026-02-27  
**作者**: Eadan172
